<?php
// $Id$

/**
 * @file
 * Contains tests for the properties.module
 */

class PropertiesBaseTestCase extends DrupalWebTestCase {

  /**
   * Create an attribute through the administration interface, load and return it.
   *
   * @param $name
   *   machine_name of the attribute, a random name is generated when left empty.
   * @param $label
   *   Label of the attribute, a random label is generated when left empty.
   *
   * @return
   *   Loaded attribute object.
   */
  protected function createAttribute($name = NULL, $label = NULL) {
    $attribute = array(
      'name' => empty($name) ? strtolower($this->randomName(8)) : $name,
      'label' => empty($label) ? $this->randomName(20) : $label,
    );
    $this->drupalPost('admin/config/content/properties/attributes/add', $attribute, t('Add'));
    $this->assertText(t('Attribute created.'));
    $attribute_object = properties_attribute_load($attribute['name']);
    $this->assertEqual($attribute_object->label, $attribute['label']);
    return $attribute_object;
  }


  protected function createCategory($name = NULL, $label = NULL, $attributes = array()) {
    $category = array(
      'name' => empty($name) ? strtolower($this->randomName(8)) : $name,
      'label' => empty($label) ? $this->randomName(20) : $label,
    );

    $this->drupalPost('admin/config/content/properties/categories/add', $category, t('Add another attribute'));

    for ($i = 0; $i < count($attributes); $i++) {

      $newAttribute = array(
        "attributes[$i][attribute]"  => $attributes[$i]->name,
      );
      $this->drupalPost(NULL, $newAttribute, t('Add another attribute'));

    }
    $this->drupalPost(NULL,NULL,t('Add'));

    $category_object = properties_category_load($category['name']);
    $this->assertEqual($category_object->label, $category['label']);

    return $category_object;
  }
}


/**
 * Tests for fields integration.
 */
class PropertiesTestCase extends PropertiesBaseTestCase {
  /**
   * Implementation of getInfo().
   */
  public static function getInfo() {
    return array
    (
      'name' => t('Properties creation'),
      'description' => t('Tests properties field type.'),
      'group' => t('Properties'),
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    parent::setUp('properties');
  }

  function testPropertyFieldCreation() {
    $admin = $this->drupalCreateUser(array('administer nodes', 'administer content types', 'create page content'));
    $this->drupalLogin($admin);

    // Create a new field.
    $edit = array(
      'fields[_add_new_field][label]' => $label = $this->randomName(),
      'fields[_add_new_field][field_name]' => $name = strtolower($this->randomName()),
      'fields[_add_new_field][type]' => 'properties',
      'fields[_add_new_field][widget_type]' => 'properties_table',
    );
    $this->drupalPost('admin/structure/types/manage/page/fields', $edit, t('Save'));
    $this->drupalPost(NULL, array(), t('Save field settings'));
    $this->drupalPost(NULL, array(), t('Save settings'));

    // Create node.
    $node = array(
      'title' => $title = $this->randomName(10),
      'field_' . $name . '[und][0][attribute]' => $this->randomName(20),
      'field_' . $name . '[und][0][value]' => $this->randomName(20),
      'field_' . $name . '[und][0][category]' => $this->randomName(15),

    );
    $this->drupalPost('node/add/page', $node, t('Save'));
    $this->assertText($node['field_' . $name . '[und][0][attribute]'], t('Content of new field is displayed.'));
    $this->assertText($node['field_' . $name . '[und][0][value]'], t('Content of new field is displayed.'));
    $this->assertText($node['field_' . $name . '[und][0][category]'], t('Content of new field is displayed.'));
  }

  /**
   * Test autocomplete functionality.
   */
  function testAutocomplete() {
    $admin = $this->drupalCreateUser(array('administer properties categories', 'administer properties attributes'));
    $this->drupalLogin($admin);
    $this->createAttribute('aaname', 'ccclabel');
    $this->createAttribute('abname', 'ccblabel');
    $this->createAttribute('bcname', 'efglabel');

    $this->drupalGet('properties_autocomplete/attribute/a');
    $json = drupal_json_decode($this->drupalGetContent());
    $this->assertEqual(2, count($json));
    $this->assertEqual($json['aaname'], t('@name (@label)', array('@name' => 'aaname', '@label' => 'ccclabel')));
    $this->assertEqual($json['abname'], t('@name (@label)', array('@name' => 'abname', '@label' => 'ccblabel')));

    $this->drupalGet('properties_autocomplete/attribute/aa');
    $json = drupal_json_decode($this->drupalGetContent());
    $this->assertEqual(1, count($json));
    $this->assertEqual($json['aaname'], t('@name (@label)', array('@name' => 'aaname', '@label' => 'ccclabel')));

    $this->drupalGet('properties_autocomplete/attribute/cc');
    $json = drupal_json_decode($this->drupalGetContent());
    $this->assertEqual(2, count($json));
    $this->assertEqual($json['aaname'], t('@name (@label)', array('@name' => 'aaname', '@label' => 'ccclabel')));
    $this->assertEqual($json['abname'], t('@name (@label)', array('@name' => 'abname', '@label' => 'ccblabel')));

    $this->drupalGet('properties_autocomplete/attribute/ef');
    $json = drupal_json_decode($this->drupalGetContent());
    $this->assertEqual(1, count($json));
    $this->assertEqual($json['bcname'], t('@name (@label)', array('@name' => 'bcname', '@label' => 'efglabel')));

    $this->drupalGet('properties_autocomplete/attribute/none');
    $json = drupal_json_decode($this->drupalGetContent());
    $this->assertEqual(0, count($json));
  }
}

/**
 * Tests for fields integration.
 */
class PropertiesAdministrationTestCase extends PropertiesBaseTestCase {
  /**
   * Implementation of getInfo().
   */
  public static function getInfo() {
    return array
    (
      'name' => t('Properties administration'),
      'description' => t('Category and Attribute administration tests'),
      'group' => t('Properties'),
    );
  }

  public function setUp() {
    parent::setUp('properties', 'properties_sql');
  }

  public function testCreating() {
    $admin = $this->drupalCreateUser(array('administer properties categories', 'administer properties attributes'));
    $this->drupalLogin($admin);

    // Create 5 properties.
    $attributes = array();
    for ($i = 0; $i < 5; $i++) {
      $attributes[$i] = $this->createAttribute();
    }

    // Create a category.
    $category = array(
      'name' => strtolower($this->randomName(8)),
      'label' => $this->randomName(20),
      'attributes[0][attribute]' => $attributes[3]->name,
    );

    // Add another attribute.
    $this->drupalPost('admin/config/content/properties/categories/add', $category, t('Add another attribute'));

    // Assert that label has been inserted.
    $this->assertText($attributes[3]->label);

    // And another one.
    $next_attribute = array(
      'attributes[1][attribute]' => $attributes[1]->name,
    );
    $this->drupalPost(NULL, $next_attribute, t('Add another attribute'));

    // Assert that label has been inserted.
    $this->assertText($attributes[1]->label);

    // Add a new attribute, try to submit.
    $new_attribute = array(
      'attributes[2][attribute]' => $name = strtolower($this->randomName()),
    );
    $this->drupalPost(NULL, $new_attribute, t('Add'));
    $this->assertText(t('Attribute @name does not exist, a label must be provided to create it.', array('@name' => $name)));

    $label = array(
      'attributes[2][label]' => $new_label = $this->randomName(20),
    );
    $this->drupalPost(NULL, $label, t('Add'));
    $this->assertText(t('Category created.'));

    // Verify that new attribute has been created.
    $this->drupalGet('admin/config/content/properties/attributes');
    $this->assertText($new_label);
    $this->assertText($name);



  }
  public function testEditCategory() {

    $admin = $this->drupalCreateUser(array('administer properties categories', 'administer properties attributes'));
    $this->drupalLogin($admin);

    /// Edit Attributes in Categories


    // Create 8 properties.
    $attributes = array();
    for ($i = 0; $i < 8; $i++) {
      $attributes[$i] = $this->createAttribute();
    }
    // Create category with these existing attributes
    $category = $this->createCategory(strtolower($this->randomName(8)), $this->randomName(20),$attributes);



    // create new attribute
    $attribute = $this->createAttribute();
    $inputfieldname = "attributes[" . $attributes[0]->name . "][attribute]";
    debug($inputfieldname);
    $editAttribute = array(
        $inputfieldname  => $attribute->name,
     );

    // replace existing attribute with the new attribute
    $this->drupalGet('admin/config/content/properties/categories');
    $this->AssertText($category->name);
    $this->clickLink(t('edit'));
    $this->drupalPost(NULL, $editAttribute, t('Save'));


    // now check if the attribute was added to that category
    $cat = properties_sql_properties_category_load($category->name);
    $newAttributeInCategory = false;
    $oldAttributeInCategory = false;
    //debug($attribute->name);
    // as the order isn't given, I walk trough the list of attributes
    foreach($cat->attributes as $attr) {
      if ($attr->name === $attribute->name) {
        $newAttributeInCategory = true;
      }
      if ($attr->name === $attributes[0]->name) {
        $oldAttributeInCategory = true;
      }
    }
    $this->AssertText(t('Category updated.'));
    // the new attribute should be in that category
    $this->AssertTrue($newAttributeInCategory);
    // the old shouldn't
    $this->AssertFalse($oldAttributeInCategory);

    // delete that property
    // doesn't work yet since the position isn't fixed.
    /*
    debug('name of attribute' . $attribute->name);
    $this->clickLink(t('edit'));
    $deleteAttribute = array(
      "attributes[5][attribute]"  => '',
    );
    $this->drupalPost(NULL, $deleteAttribute, t('Save'));

    $cat = properties_sql_properties_category_load($category->name);
    $inCategory = false;
    foreach($cat->attributes as $attr) {
      if ($attr->name === $attribute->name) {
        $inCategory = true;
      }
    }
    $this->AssertFalse($inCategory);*/

  }

}